<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta charset="UTF-8">

    <style>
        .datahtml{
            width: 90%;
            max-height: 300px;
            overflow-y:auto;
            padding-bottom: 100px;
            background-color: rgb(231, 224, 224);
        }
    </style>
</head>

<body>
    <!-- 目录树 -->
    <div id="elementapp">
        <el-tree :data="data" node-key="id" default-expand-all :expand-on-click-node="false" draggable >
            <span class="custom-tree-node" slot-scope="{ node, data }">
                <span>
                    <el-tag size="mini" effect="plain" type="success" v-if="data.type==1">链接</el-tag>
                    <el-tag size="mini" effect="plain" v-if="data.type==2">目录</el-tag>
                    {{ node.label }}
                    <el-button v-if="data.type==1" type="text" size="mini">
                        {{data.url}}
                    </el-button>　　　　　　　
                </span>
                <span>
                    <el-tag size="mini" @click="() =>{newObj = data;updateVisible=true}" type="warning">update </el-tag>
                    <el-tag size="mini" @click="() => {newData = data;dialogTableVisible=true}" type="warning">Append </el-tag>
                    <el-tag size="mini" @click="() => remove(node, data)" type="warning">Delete</el-tag>
                </span>
            </span>
        </el-tree>
        <el-dialog title="增加" :visible.sync="dialogTableVisible">
            <el-form ref="form" :model="obj" label-width="80px">
                <el-form-item label="标题">
                    <el-input v-model="obj.label"></el-input>
                </el-form-item>
                <el-form-item label="链接">
                    <el-input v-model="obj.url"></el-input>
                </el-form-item>
                <el-form-item label="类型">
                    <el-radio-group v-model="obj.type">
                        <el-radio label="1">链接</el-radio>
                        <el-radio label="2">文件</el-radio>
                    </el-radio-group>
                </el-form-item>
                <el-form-item label="顶级标题">
                    <el-radio-group v-model="obj.topTitle">
                        <el-radio label="1">否</el-radio>
                        <el-radio label="2">是</el-radio>
                    </el-radio-group>
                </el-form-item>
                <el-form-item>
                    <el-button type="primary" @click="onSubmit"  >立即创建</el-button>
                    <el-button @click="dialogTableVisible = false;initObj()">取消</el-button>
                </el-form-item>
            </el-form>

        </el-dialog>
        <el-dialog title="修改" :visible.sync="updateVisible">
            <el-form ref="form" :model="newObj" label-width="80px">
                {{newObj}}
                <el-form-item label="标题">
                    <el-input v-model="newObj.label"></el-input>
                </el-form-item>
                <el-form-item label="链接">
                    <el-input v-model="newObj.url"></el-input>
                </el-form-item>
                <el-form-item label="类型">
                    <el-radio-group v-model="newObj.type">
                        <el-radio label="1">链接</el-radio>
                        <el-radio label="2">文件夹</el-radio>
                    </el-radio-group>
                </el-form-item>
                <el-form-item>
                    <el-button type="primary" @click="onUpdate">立即创建</el-button>
                    <el-button @click="updateVisible = false;initObj()">取消</el-button>
                </el-form-item>
            </el-form>

        </el-dialog>
        <br>
        <br>
        <br>
        <br>
        <!-- <el-button type="primary" @click="jsonVisible = true">目录转换成json</el-button>
        <el-button type="primary" @click="showMd">目录转换成markdown</el-button>
        <el-dialog title="目录转换成json" :visible.sync="jsonVisible">
            {{data}}
            <hr>
            <el-button type="primary" @click="downloadJson()">直接下载</el-button>

        </el-dialog> -->

        <hr>
     



        <el-row>
            <el-col :span="12">
                <h1>json   <el-button type="primary" @click="downloadJson()" >下载json</el-button>
                    <el-button type="success"  @click="copyText('json')">复制json</el-button>
                </h1>
                <div v-html="data" class="datahtml"></div>
              
            </el-col>
            <el-col :span="12">
                <h1>md <el-button type="primary" @click="downloadMd()">下载md</el-button>
                    <el-button  type="success" @click="copyText('md')">复制md</el-button>
                </h1>
                <div v-html="mdData"  class="datahtml"></div>        
            </el-col>
        </el-row>
    </div>

    <br>
    <br>
    <br>
    <br>     <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>

    <!-- element ui相关组件 -->
    <script src="./notebook_asset/elementui/vue.js"></script>
    <!-- 引入样式 -->
    <link rel="stylesheet" href="./notebook_asset/elementui/elementui-2.15.8.css">
    <!-- 引入组件库 -->
    <script src="./notebook_asset/elementui/elementuijs.js"></script>
    <script src="./notebook_asset/js/jquery.js"></script>

    <script src="https://cdn.bootcdn.net/ajax/libs/FileSaver.js/2.0.5/FileSaver.js"></script>

 


    <script>
        //  1请求地址 2参数 3，请求方式
        const request = (url, params, method = "get") => {
            // 不限于jquery，所有请求到的数据都可以用resolve返回
            return new Promise((resolve, reject) => {
                $.ajax({
                    url,
                    method,
                    data: params,
                    success: function (res) {
                        resolve(res)
                    },
                    error: function () {
                        reject('出错')
                    }
                })
            })
        }


        let id = Math.round(Math.random()*100000000);;
        var str = "";
        var app = new Vue({
            el: '#elementapp',
            data() {
                return {
                    data: [],
                    dialogTableVisible: false,
                    updateVisible: false,
                    
                    obj: {
                        label: "",
                        url: "",
                        type: "1",
                        topTitle:"1"
                    },
                    newData: {},
                    newObj:{},
                    mdData: ""
                }
            },
            mounted() {
                // 加载目录
                request("content.json", {}).then(res => {
                    this.data = res
                    this.showMd()
                })
            },
            watch:{  //监控name属性
                data:{
                    deep:true, //开启深度监听
                    handler(v){
                       this.showMd()
                    }
                }
            },
            methods: {
                showMd() {
                    str = ""
                    treeToStr(this.data);
                    this.mdData = str;
                },
                downloadJson() {
                    let file = new File([JSON.stringify(this.data)], 'content.json', {
                        type: 'text/plain;charset=utf-8'
                    });
                    saveAs(file);
                },
                downloadMd(){
                    let file = new File([this.mdData.replace(/(<br>)/g,'\n').replace(/(&nbsp;)/g,' ')], '_sidebar.md', {
                        type: 'text/plain;charset=utf-8'
                    });
                    saveAs(file);
                },
                onSubmit() {
                    var obj = this.obj;
                    var newChild = {
                        id: id++,
                        label: obj.label,
                        url: obj.url,
                        type: obj.type,
                        children: []
                    };
                    if(obj.topTitle == 2){
                        this.data.push(newChild)
                    }else{
                         var data = this.newData;
                        if (!data.children) {
                            this.$set(data, 'children', []);
                        }
                        data.children.push(newChild);

                        this.dialogTableVisible = false;
                        this.initObj();
                    }
 
                },
                onUpdate(){
                    var obj = this.newObj;
                    var newObj1 = {
                        id: id++,
                        label: obj.label,
                        url: obj.url,
                        type: obj.type,
                        children: []
                    };
                    this.newObj  = newObj1;
                    this.updateVisible = false;
                    this.initObj();
                },
                initObj() {
                    this.obj = {
                        lable: "",
                        url: "",
                        type: "1",
                        topTitle:"1"
                    }
                },


                remove(node, data) {
                    const parent = node.parent;
                    const children = parent.data.children || parent.data;
                    const index = children.findIndex(d => d.id === data.id);
                    children.splice(index, 1);
                },
                update(node,data){
                    const parent = node.parent;
                    const children = parent.data.children || parent.data;
                    const index = children.findIndex(d => d.id === data.id);
                    data.url = 1
                    console.log(data);
                    // children.splice(index, 1);
                },
                copyText(copytext) {
                    if(copytext == "json"){
                        content = JSON.stringify(this.data)
                    }else if(copytext == "md"){
                        content = this.mdData.replace(/(<br>)/g,'\n').replace(/(&nbsp;)/g,' ')
                    }
                    console.log(content);
                    const text = document.createElement('textarea'); // 创建节点
                    text.setAttribute('readonly', 'readonly');
                    text.value = content; // 赋值
                    document.body.appendChild(text); // 插入节点
                    text.setSelectionRange(0, text.value.length);
                    text.select(); // 选中节点
                    document.execCommand('copy'); // 执行浏览器复制方法
                    if (document.body.removeChild(text)) {
                        this.$message({ type: 'success', message: '复制成功' })
                    } else {
                        this.$message({ type: 'error', message: '复制失败' })
                    }
                }
 
            },
        })
    </script>
    <!-- // 新添加的方法 -->
    <script>
    
    // 获取url
    function getUrl(data,space ="") {
        if (data.type == 1) {
            // 如果是链接
            return space+"* [" + data.label + "](" + data.url + ")<br>";
        } else {
            // 文件夹
            return space+"* " + data.label + "<br>";
        }
    }
    function treeToStr(array) { for (i in array) { var data = array[i]; str += getUrl(data,"");if (data.children) { treeToStr1(data.children) }        }    }
    function treeToStr1(array) { for (i in array) { var data = array[i]; str += getUrl(data,"&nbsp;&nbsp;");if (data.children) { treeToStr2(data.children) }        }    }
    function treeToStr2(array) { for (i in array) { var data = array[i]; str += getUrl(data,"&nbsp;&nbsp;&nbsp;&nbsp;");if (data.children) { treeToStr3(data.children) }        }    }
    function treeToStr3(array) { for (i in array) { var data = array[i]; str += getUrl(data,"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");if (data.children) { treeToStr4(data.children) }        }    }
    function treeToStr4(array) { for (i in array) { var data = array[i]; str += getUrl(data,"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");if (data.children) { treeToStr5(data.children) }        }    }
    function treeToStr5(array) { for (i in array) { var data = array[i]; str += getUrl(data,"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");if (data.children) { treeToStr6(data.children) }        }    }
    function treeToStr6(array) { for (i in array) { var data = array[i]; str += getUrl(data,"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");if (data.children) { treeToStr7(data.children) }        }    }
    function treeToStr7(array) { for (i in array) { var data = array[i]; str += getUrl(data,"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");if (data.children) { treeToStr8(data.children) }        }    }
    function treeToStr8(array) { for (i in array) { var data = array[i]; str += getUrl(data,"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");if (data.children) { treeToStr9(data.children) }        }    }
    function treeToStr9(array) { for (i in array) { var data = array[i]; str += getUrl(data,"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");if (data.children) { treeToStr10(data.children) }        }    }
    function treeToStr10(array) { for (i in array) { var data = array[i]; str += getUrl(data,"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");if (data.children) { treeToStr11(data.children) }        }    }
    function treeToStr11(array) { for (i in array) { var data = array[i]; str += getUrl(data,"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");        }    }



    </script>
</body>

</html>